var SpPropertyBag=function(){function e(){if(this.divContainerId="divSpPropertyBag",this.divBlockContainerId="divBlockSpPropertyBag",this.reloadRequired=!1,this.refreshTableRequired=!1,this.ctx=SP.ClientContext.get_current(),this.web=this.ctx.get_web(),"function"!=typeof this.web.doesUserHavePermissions)return void this.showMessageOnDialog("Unable to check permissions","Cannot check permissions against a non-securable object.");var e=new SP.BasePermissions;e.set(SP.PermissionKind.manageWeb),this.per=this.web.doesUserHavePermissions(e);var t=Function.createDelegate(this,function(e,t){var i=this.per.get_value();i?this.getWebProperties():this.showMessageOnDialog("No required permissions","Current user does not have the required permissions")}),i=Function.createDelegate(this,function(e,t){SP.UI.Notify.addNotification("Failed to check the current user permissions...<br>"+t.get_message(),!1)});this.ctx.executeQueryAsync(t,i)}return e.prototype.getWebProperties=function(){this.ctx=SP.ClientContext.get_current(),this.web=this.ctx.get_web(),this.allProperties=this.web.get_allProperties(),this.ctx.load(this.web),this.ctx.load(this.allProperties);var e=Function.createDelegate(this,function(e,t){this.showPropertiesDialog(this.allProperties.get_fieldValues())}),t=Function.createDelegate(this,function(e,t){SP.UI.Notify.addNotification("Failed to get web properties...<br>"+t.get_message(),!1)});this.ctx.executeQueryAsync(e,t)},e.prototype.toggleBlockModal=function(e){var t=document.getElementById(this.divBlockContainerId);t.style.display=e?"block":"none"},e.prototype.refreshAllPropertiesTable=function(){this.ctx=SP.ClientContext.get_current(),this.web=this.ctx.get_web(),this.allProperties=this.web.get_allProperties(),this.ctx.load(this.web),this.ctx.load(this.allProperties);var e=Function.createDelegate(this,function(e,t){this.refreshTableRequired=!1;var i=this.allProperties.get_fieldValues(),o=this.getItemArray(i),r=document.getElementById(this.divContainerId);r.innerHTML=this.buildTable(o),this.toggleBlockModal(!1)}),t=Function.createDelegate(this,function(e,t){SP.UI.Notify.addNotification("Failed to get web properties...<br>"+t.get_message(),!1)});this.ctx.executeQueryAsync(e,t)},e.prototype.buildTable=function(e){for(var t=['<hr><table style="margin: 1em;">'],i=0,o=e.length;i<o;i++){var r=e[i];t.push("<tr>"),t.push('<td style="text-align: right; padding-top: 15px;"><b>'+r.prop+"</b></td>"),t.push('<td style="padding-top: 15px;"><input id="prop'+i+'" style="width:240px; " type="text" value="'+r.value+'"></inpu></td>'),t.push('<td style="padding-top: 15px;"><button onclick="_spPropertyBag.setProperty(\''+r.prop+"','prop"+i+"'); return false;\">Update</button></td>"),t.push('<td style="padding-top: 15px;"><button style="color: red; min-width: 1em;" onclick="_spPropertyBag.deleteProperty(\''+r.prop+"','prop"+i+"'); return false;\">X</button></td>"),t.push("</tr>")}return t.push("</table>"),t.push("<hr><h3>Add a new property:</h3>"),t.push('<div style="margin: 1em; padding-bottom: 2em;">Key: <input id="newKey"></inpu>'),t.push('&nbsp;&nbsp;&nbsp;Value: <input id="newValue"></inpu>'),t.push('&nbsp;<button onclick="_spPropertyBag.addProperty(); return false;">Add</button></div>'),t.push("<div></div>"),t.push('<div id="'+this.divBlockContainerId+'" style="display:none; position: absolute; width: 100%; height: 100%; background-color: gray; top: 0; left: 0;opacity: .8;"></div>'),t.join("\n")},e.prototype.executeChanges=function(){this.ctx.get_web().update();var e=Function.createDelegate(this,function(e,t){console.log("Web properties successfully modified"),this.reloadRequired?window.location.reload():this.refreshTableRequired?this.refreshAllPropertiesTable():this.toggleBlockModal(!1)}),t=Function.createDelegate(this,function(e,t){SP.UI.Notify.addNotification("Failed to set web property!...<br>"+t.get_message(),!1)});this.ctx.executeQueryAsync(e,t)},e.prototype.setProperty=function(e,t){this.toggleBlockModal(!0);var i=document.getElementById(t).value;this.allProperties.set_item(e,i),this.executeChanges()},e.prototype.deleteProperty=function(e,t){if(confirm("Are you sure you want to remove this property? The page will be refreshed after the property has been deleted.")){this.toggleBlockModal(!0);var i=document.getElementById(t).parentNode.parentNode;i.parentNode.removeChild(i),this.allProperties.set_item(e),this.executeChanges(),this.reloadRequired=!0}},e.prototype.addProperty=function(){this.toggleBlockModal(!0),this.refreshTableRequired=!0;var e=document.getElementById("newKey").value,t=document.getElementById("newValue").value;document.getElementById("newValue").value="",document.getElementById("newKey").value="",this.allProperties.set_item(e,t),this.executeChanges()},e.prototype.getItemArray=function(e){var t,i,o=[];for(t in e)e.hasOwnProperty(t)&&(i=typeof e[t],"string"===i&&o.push({prop:t,value:e[t].replace(/"/g,"&quot;")}));return o.sort(function(e,t){return e.prop.localeCompare(t.prop)}),o},e.prototype.showModal=function(e,t){SP.UI.ModalDialog.showModalDialog({title:e,html:t,showClose:!0,autoSize:!0,dialogReturnValueCallback:function(e){this.reloadRequired&&window.location.reload()}})},e.prototype.showMessageOnDialog=function(e,t){var i=document.createElement("div"),o=document.createElement("hr"),r=document.createElement("p");i.id=this.divContainerId,r.textContent=t,i.appendChild(o),i.appendChild(r),this.showModal(e,i)},e.prototype.showPropertiesDialog=function(e){var t=this.getItemArray(e),i=document.createElement("div");i.id=this.divContainerId,i.innerHTML=this.buildTable(t),this.showModal("Property Bag Editor",i)},e}();SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){_spPropertyBag=new SpPropertyBag});